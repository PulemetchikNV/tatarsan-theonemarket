import { BaseAgent } from './baseAgent.js';
import type { DataCollectorResult, MarketResearcherResult } from '../../types/index.js';
import {
  researchMarketTool,
  getTopTechnologiesTool,
  getTechDemandTool,
} from '../tools/index.js';

/**
 * Market Researcher Agent
 * 
 * –ê–í–¢–û–ù–û–ú–ù–´–ô –∞–≥–µ–Ω—Ç –¥–ª—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è IT-—Ä—ã–Ω–∫–∞.
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç LangChain tools –∏ –°–ê–ú —Ä–µ—à–∞–µ—Ç:
 * - –ö–∞–∫–∏–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è –ø—Ä–æ–≤–µ—Å—Ç–∏
 * - –ö–∞–∫–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å
 * - –ö–∞–∫ –æ—Ü–µ–Ω–∏—Ç—å –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞
 * 
 * Tools:
 * - research_market: –ø—Ä–æ–≤–æ–¥–∏—Ç —Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
 * - get_top_technologies: –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ø–æ —Å–ø—Ä–æ—Å—É
 * - get_tech_demand: –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø—Ä–æ—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é
 */
export class MarketResearcherAgent extends BaseAgent {

  constructor() {
    super(
      'MarketResearcher',
      [
        researchMarketTool,
        getTopTechnologiesTool,
        getTechDemandTool,
      ],
      `–¢—ã - Market Researcher Agent, —ç–∫—Å–ø–µ—Ä—Ç –ø–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—é IT-—Ä—ã–Ω–∫–∞ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω–∞.

–¢–≤–æ—è –∑–∞–¥–∞—á–∞: –ø—Ä–æ–≤–µ—Å—Ç–∏ –ü–û–õ–ù–û–ï —Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏.

–î–æ—Å—Ç—É–ø–Ω—ã–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
1. research_market - –ø—Ä–æ–≤–æ–¥–∏—Ç —Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ (—Ç—Ä–µ–Ω–¥—ã, –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç—ã, –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞)
2. get_top_technologies - –ø–æ–ª—É—á–∞–µ—Ç —Ç–æ–ø —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π –ø–æ —Å–ø—Ä–æ—Å—É –Ω–∞ —Ä—ã–Ω–∫–µ
3. get_tech_demand - –ø—Ä–æ–≤–µ—Ä—è–µ—Ç —Å–ø—Ä–æ—Å –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—É—é —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—é

–°—Ç—Ä–∞—Ç–µ–≥–∏—è –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è:
1. –ù–∞—á–Ω–∏ —Å research_market —á—Ç–æ–±—ã –ø–æ–ª—É—á–∏—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É —Ä—ã–Ω–∫–∞
2. –ò—Å–ø–æ–ª—å–∑—É–π get_top_technologies —á—Ç–æ–±—ã –ø–æ–Ω—è—Ç—å –∫–∞–∫–∏–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω—ã
3. –ï—Å–ª–∏ —É –∫–æ–º–ø–∞–Ω–∏–∏ –µ—Å—Ç—å —Å–ø–µ—Ü–∏—Ñ–∏—á–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ - –ø—Ä–æ–≤–µ—Ä—å –∏—Ö —Å–ø—Ä–æ—Å —á–µ—Ä–µ–∑ get_tech_demand
4. –°–æ–ø–æ—Å—Ç–∞–≤—å tech stack –∫–æ–º–ø–∞–Ω–∏–∏ —Å —Ä—ã–Ω–æ—á–Ω—ã–º —Å–ø—Ä–æ—Å–æ–º

–§–æ—Ä–º–∞—Ç –∞–Ω–∞–ª–∏–∑–∞:
–ü–æ—Å–ª–µ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤, –¥–∞–π –°–¢–†–£–ö–¢–£–†–ò–†–û–í–ê–ù–ù–´–ô –∞–Ω–∞–ª–∏–∑:

üìä –†–´–ù–û–ß–ù–´–ï –¢–†–ï–ù–î–´:
[—Å–ø–∏—Å–æ–∫ –∫–ª—é—á–µ–≤—ã—Ö —Ç—Ä–µ–Ω–¥–æ–≤]

üî• –°–ü–†–û–° –ù–ê –¢–ï–•–ù–û–õ–û–ì–ò–ò:
[—Ç–æ–ø —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π —Å —Ä–µ–π—Ç–∏–Ω–≥–∞–º–∏]

üèÜ –ö–û–ù–ö–£–†–ï–ù–¢–ù–ê–Ø –°–†–ï–î–ê:
[–∞–Ω–∞–ª–∏–∑ –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤]

üìà –ü–û–¢–ï–ù–¶–ò–ê–õ –†–û–°–¢–ê:
[–æ—Ü–µ–Ω–∫–∞ –∏ –æ–±–æ—Å–Ω–æ–≤–∞–Ω–∏–µ]

üí° –†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò:
[–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏]

–í–ê–ñ–ù–û: –ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –¥–ª—è –ø–æ–ª–Ω–æ–π –∫–∞—Ä—Ç–∏–Ω—ã —Ä—ã–Ω–∫–∞!`
    );
  }

  /**
   * –ü—Ä–æ–≤–æ–¥–∏—Ç —Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ AI –∞–≥–µ–Ω—Ç–∞
   * –ê–≥–µ–Ω—Ç –°–ê–ú —Ä–µ—à–∞–µ—Ç –∫–∞–∫–∏–µ –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
   */
  async research(companyName: string, collectedData: DataCollectorResult): Promise<MarketResearcherResult> {
    return this.execute(async () => {
      this.log(`Researching market for: ${companyName}`);

      // –§–æ—Ä–º–∏—Ä—É–µ–º –∫–æ–Ω—Ç–µ–∫—Å—Ç –¥–ª—è –∞–≥–µ–Ω—Ç–∞
      const techStack = collectedData.hhData?.requiredSkills || [];
      const industry = collectedData.habrData?.topics?.[0] || 'tech';

      // –í—ã–∑—ã–≤–∞–µ–º AI –∞–≥–µ–Ω—Ç–∞ - –æ–Ω —Å–∞–º —Ä–µ—à–∏—Ç –∫–∞–∫–∏–µ tools –∏—Å–ø–æ–ª—å–∑–æ–≤–∞—Ç—å
      const response = await this.invokeAgent(
        `–ü—Ä–æ–≤–µ–¥–∏ –ü–û–õ–ù–û–ï —Ä—ã–Ω–æ—á–Ω–æ–µ –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ –¥–ª—è –∫–æ–º–ø–∞–Ω–∏–∏ "${companyName}".

–ö–æ–Ω—Ç–µ–∫—Å—Ç –æ –∫–æ–º–ø–∞–Ω–∏–∏:
- Tech Stack: ${techStack.join(', ') || '–Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω'}
- –ò–Ω–¥—É—Å—Ç—Ä–∏—è: ${industry}
- –í–∞–∫–∞–Ω—Å–∏–π –Ω–∞ —Ä—ã–Ω–∫–µ: ${collectedData.hhData?.totalVacancies || 0}
- –°—Ä–µ–¥–Ω—è—è –∑–∞—Ä–ø–ª–∞—Ç–∞: ${collectedData.hhData?.avgSalary || '–Ω–µ –∏–∑–≤–µ—Å—Ç–Ω–∞'}
- GitHub –∞–∫—Ç–∏–≤–Ω–æ—Å—Ç—å: ${collectedData.githubData?.activity || 0} –∫–æ–º–º–∏—Ç–æ–≤/–º–µ—Å—è—Ü

–ò—Å–ø–æ–ª—å–∑—É–π –í–°–ï –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã:
1. research_market - –¥–ª—è –æ–±—â–µ–≥–æ –∞–Ω–∞–ª–∏–∑–∞
2. get_top_technologies - –¥–ª—è –ø–æ–Ω–∏–º–∞–Ω–∏—è —Ä—ã–Ω–∫–∞
3. get_tech_demand - –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ —Å–ø—Ä–æ—Å–∞ –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏ –∫–æ–º–ø–∞–Ω–∏–∏

–î–∞–π –ü–û–õ–ù–´–ô —Å—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –∞–Ω–∞–ª–∏–∑!`
      );

      this.log('Market research completed', { 
        responseLength: JSON.stringify(response).length 
      });

      // –ü–∞—Ä—Å–∏–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç —Ä–∞–±–æ—Ç—ã –∞–≥–µ–Ω—Ç–∞
      const result = this.parseAgentResponse(response, companyName, industry);
      
      return result;
    });
  }

  /**
   * –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –∞–≥–µ–Ω—Ç–∞ –∏ —Ñ–æ—Ä–º–∏—Ä—É–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç –∏—Å—Å–ª–µ–¥–æ–≤–∞–Ω–∏—è
   */
  private parseAgentResponse(
    response: any,
    companyName: string,
    industry: string
  ): MarketResearcherResult {
    this.log('Parsing market research response');

    // TODO: –ü—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä—Å–∏–Ω–≥ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–≤ tools –∏–∑ LangChain response
    // –°–µ–π—á–∞—Å –¥–ª—è MVP –≤–æ–∑–≤—Ä–∞—â–∞–µ–º mock –¥–∞–Ω–Ω—ã–µ
    
    return {
      marketTrends: [
        'AI –∏ Machine Learning –¥–æ–º–∏–Ω–∏—Ä—É—é—Ç –≤ —Å–ø—Ä–æ—Å–µ',
        '–†–æ—Å—Ç –∏–Ω—Ç–µ—Ä–µ—Å–∞ –∫ Cloud Native —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º',
        'TypeScript –≤—ã—Ç–µ—Å–Ω—è–µ—Ç JavaScript',
        '–î–µ—Ñ–∏—Ü–∏—Ç DevOps —Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç–æ–≤',
      ],
      demandForTech: {
        TypeScript: 95,
        Python: 92,
        React: 90,
        'Node.js': 88,
        PostgreSQL: 85,
      },
      competitorAnalysis: `–í —Ä–µ–≥–∏–æ–Ω–µ –¢–∞—Ç–∞—Ä—Å—Ç–∞–Ω –≤—ã—è–≤–ª–µ–Ω–æ 5-7 –ø—Ä—è–º—ã—Ö –∫–æ–Ω–∫—É—Ä–µ–Ω—Ç–æ–≤ –¥–ª—è ${companyName}. –†—ã–Ω–æ–∫ –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–æ—Å—Ç 12-15% –≤ –≥–æ–¥.`,
      growthPotential: 75,
    };
  }
}

export const marketResearcherAgent = new MarketResearcherAgent();

