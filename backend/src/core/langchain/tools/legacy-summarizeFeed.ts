import { z } from 'zod'
import { tool } from '@langchain/core/tools'
import { rssService } from '../../services/rssService'
import { createModuleLogger } from '../../utils/logger'
import type { ArticlePreview } from '../../parsers/types'

const logger = createModuleLogger('summarizeFeedTool')

/**
 * LangChain Tool: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å—Ç–∞—Ç–µ–π –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
 * 
 * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç—å–∏ –∏–∑ RSS-–ª–µ–Ω—Ç—ã –¥–ª—è –ø–æ—Å–ª–µ–¥—É—é—â–µ–π —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ AI –∞–≥–µ–Ω—Ç–æ–º.
 * –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –∫—Ä–∞—Ç–∫—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å—Ç–∞—Ç—å—è—Ö, –∫–æ—Ç–æ—Ä—É—é –∞–≥–µ–Ω—Ç –º–æ–∂–µ—Ç –æ–±–æ–±—â–∏—Ç—å.
 */
export const summarizeFeedTool = tool(
    async ({ source, query, limit, offset }) => {
        try {
            logger.info({ source, query, limit, offset }, 'Tool summarizeFeed –≤—ã–∑–≤–∞–Ω')

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            if (!rssService.isSourceSupported(source)) {
                const available = rssService.getAvailableSources().join(', ')
                return `‚ùå –ò—Å—Ç–æ—á–Ω–∏–∫ "${source}" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: ${available}`
            }

            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—å–∏
            const articles = await rssService.fetchFeed(source, {
                query,
                limit: limit || 5,
                offset: offset || 0,
            })

            if (articles.length === 0) {
                return `üì≠ –°—Ç–∞—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ –∑–∞–ø—Ä–æ—Å—É: –∏—Å—Ç–æ—á–Ω–∏–∫="${source}"${query ? `, –∑–∞–ø—Ä–æ—Å="${query}"` : ''}`
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Å—Ç–∞—Ç—å–∏ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏
            const articlesText = articles.map((article: ArticlePreview, index: number) => {
                const date = article.publishedAt.toLocaleDateString('ru-RU')
                return `${index + 1}. "${article.title}" (${date})
   –ê–≤—Ç–æ—Ä: ${article.author || '–ê–Ω–æ–Ω–∏–º'}
   –¢–µ–≥–∏: ${article.tags.join(', ')}
   –û–ø–∏—Å–∞–Ω–∏–µ: ${article.summary || '–ù–µ—Ç –æ–ø–∏—Å–∞–Ω–∏—è'}
   –°—Å—ã–ª–∫–∞: ${article.url}`
            }).join('\n\n')

            logger.info({ articlesCount: articles.length, source, query, offset }, '–°—Ç–∞—Ç—å–∏ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏ –ø–æ–ª—É—á–µ–Ω—ã')

            const pageInfo = offset && offset > 0 
                ? ` (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${Math.floor(offset / (limit || 5)) + 1})`
                : ''

            return `üìö –ü–æ–ª—É—á–µ–Ω–æ ${articles.length} —Å—Ç–∞—Ç–µ–π –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏${pageInfo}:

${articlesText}

‚ö° –¢–µ–ø–µ—Ä—å –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç–∏ —Å—Ç–∞—Ç—å–∏ –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –∫—Ä–∞—Ç–∫–∏–π –æ–±–∑–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º –∏ —Ç—Ä–µ–Ω–¥–æ–≤. –£–∫–∞–∂–∏ –Ω–∞–∏–±–æ–ª–µ–µ –∏–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Å—Ç–∞—Ç—å–∏ –∏ –∫–ª—é—á–µ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏, –∫–æ—Ç–æ—Ä—ã–µ –≤ –Ω–∏—Ö –æ–±—Å—É–∂–¥–∞—é—Ç—Å—è.`

        } catch (error) {
            logger.error({ err: error, source, query, limit }, '–û—à–∏–±–∫–∞ –≤ summarizeFeedTool')
            return `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—å–∏ –¥–ª—è —Å—É–º–º–∞—Ä–∏–∑–∞—Ü–∏–∏: ${error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`
        }
    },
    {
        name: 'summarize_feed',
        description: `–ü–æ–ª—É—á–∞–µ—Ç –ø–æ–¥–±–æ—Ä–∫—É —Å—Ç–∞—Ç–µ–π –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∫—Ä–∞—Ç–∫–æ–≥–æ –æ–±–∑–æ—Ä–∞ –∏ –∞–Ω–∞–ª–∏–∑–∞ —Ç—Ä–µ–Ω–¥–æ–≤ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å:
- –•–æ—á–µ—Ç —É–∑–Ω–∞—Ç—å –æ–±—â—É—é –∫–∞—Ä—Ç–∏–Ω—É –ø–æ —Ç–µ–º–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä: "—á—Ç–æ —Å–µ–π—á–∞—Å –ø–∏—à—É—Ç –ø—Ä–æ React")
- –ü—Ä–æ—Å–∏—Ç —Å–¥–µ–ª–∞—Ç—å –æ–±–∑–æ—Ä —Å—Ç–∞—Ç–µ–π
- –°–ø—Ä–∞—à–∏–≤–∞–µ—Ç –æ —Ç—Ä–µ–Ω–¥–∞—Ö –∏ –ø–æ–ø—É–ª—è—Ä–Ω—ã—Ö —Ç–µ–º–∞—Ö
- –•–æ—á–µ—Ç —É–≤–∏–¥–µ—Ç—å "—á—Ç–æ –Ω–æ–≤–æ–≥–æ –≤" –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω–æ–π –æ–±–ª–∞—Å—Ç–∏
- –ü—Ä–æ—Å–∏—Ç –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å –ë–û–õ–¨–®–ï —Å—Ç–∞—Ç–µ–π –¥–ª—è –æ–±–∑–æ—Ä–∞

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- source: –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç–µ–π (habr, vcru). habr - –•–∞–±—Ä, vcru - vc.ru
- query: –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å/—Ç–µ–º–∞ (frontend, backend, nodejs, react –∏ —Ç.–¥.). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
- limit: –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
- offset: —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0). –ò—Å–ø–æ–ª—å–∑—É–π –µ—Å–ª–∏ –Ω—É–∂–Ω–æ –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞—Ç—å —Å–ª–µ–¥—É—é—â—É—é –ø–æ—Ä—Ü–∏—é —Å—Ç–∞—Ç–µ–π

–í–ê–ñ–ù–û –ø—Ä–æ offset:
- –ü–µ—Ä–≤—ã–π –æ–±–∑–æ—Ä: offset=0
- –î–ª—è —Ä–∞—Å—à–∏—Ä–µ–Ω–Ω–æ–≥–æ –∞–Ω–∞–ª–∏–∑–∞ —Å –Ω–æ–≤—ã–º–∏ —Å—Ç–∞—Ç—å—è–º–∏: offset=–ø—Ä–µ–¥—ã–¥—É—â–∏–π_limit
- –î–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ vcru offset –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç, –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ limit

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π —Å –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º. –ü–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è –¥–∞–Ω–Ω—ã—Ö - –ø—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π –∏—Ö –∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é –æ–±–æ–±—â–µ–Ω–Ω—ã–π –æ–±–∑–æ—Ä –æ—Å–Ω–æ–≤–Ω—ã—Ö —Ç–µ–º –∏ —Ç—Ä–µ–Ω–¥–æ–≤.`,
        schema: z.object({
            source: z.enum(['habr', 'vcru']).describe('–ò—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç–µ–π: habr (–•–∞–±—Ä), vcru (vc.ru)'),
            query: z.string().optional().describe('–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å/—Ç–µ–º–∞ (frontend, backend, nodejs, react –∏ —Ç.–¥.). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏'),
            limit: z.number().optional().describe('–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5, –º–∞–∫—Å–∏–º—É–º 10)'),
            offset: z.number().optional().describe('–°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏. –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞ —Å–ª–µ–¥—É—é—â–µ–π –ø–æ—Ä—Ü–∏–∏ —Å—Ç–∞—Ç–µ–π. 0 = –ø–µ—Ä–≤—ã–µ —Å—Ç–∞—Ç—å–∏, 5 = —Å–ª–µ–¥—É—é—â–∏–µ 5 —Å—Ç–∞—Ç–µ–π –∏ —Ç.–¥.'),
        }),
    }
)

