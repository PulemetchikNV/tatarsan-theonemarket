import { z } from 'zod'
import { tool } from '@langchain/core/tools'
import { rssService } from '../../services/rssService'
import { createModuleLogger } from '../../utils/logger'
import type { ArticlePreview } from '../../parsers/types'

const logger = createModuleLogger('newPostsTool')

/**
 * LangChain Tool: –ø–æ–ª—É—á–µ–Ω–∏–µ —Å–≤–µ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π –∏–∑ RSS-–ª–µ–Ω—Ç
 * 
 * –ò—Å–ø–æ–ª—å–∑—É–µ—Ç rssService –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å—Ç–∞—Ç–µ–π –∏–∑ —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞
 * —Å —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–µ–π –ø–æ —Ç–µ–º–µ –∏ –¥–∞—Ç–µ.
 */
export const newPostsTool = tool(
    async ({ source, query, limit, offset, sinceHours }) => {
        try {
            logger.info({ source, query, limit, offset, sinceHours }, 'Tool newPosts –≤—ã–∑–≤–∞–Ω')

            // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–¥–µ—Ä–∂–∫—É –∏—Å—Ç–æ—á–Ω–∏–∫–∞
            if (!rssService.isSourceSupported(source)) {
                const available = rssService.getAvailableSources().join(', ')
                return `‚ùå –ò—Å—Ç–æ—á–Ω–∏–∫ "${source}" –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è. –î–æ—Å—Ç—É–ø–Ω—ã–µ –∏—Å—Ç–æ—á–Ω–∏–∫–∏: ${available}`
            }

            // –í—ã—á–∏—Å–ª—è–µ–º –¥–∞—Ç—É –¥–ª—è —Ñ–∏–ª—å—Ç—Ä–∞ (–µ—Å–ª–∏ —É–∫–∞–∑–∞–Ω–æ)
            const since = sinceHours 
                ? new Date(Date.now() - sinceHours * 60 * 60 * 1000)
                : undefined

            // –ü–æ–ª—É—á–∞–µ–º —Å—Ç–∞—Ç—å–∏
            const articles = await rssService.fetchFeed(source, {
                query,
                limit: limit || 5,
                offset: offset || 0,
                since,
            })

            if (articles.length === 0) {
                return `üì≠ –°—Ç–∞—Ç–µ–π –Ω–µ –Ω–∞–π–¥–µ–Ω–æ –ø–æ –∑–∞–ø—Ä–æ—Å—É: –∏—Å—Ç–æ—á–Ω–∏–∫="${source}"${query ? `, –∑–∞–ø—Ä–æ—Å="${query}"` : ''}`
            }

            // –§–æ—Ä–º–∞—Ç–∏—Ä—É–µ–º —Ä–µ–∑—É–ª—å—Ç–∞—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const startIndex = (offset || 0) + 1 // –ù–∞—á–∏–Ω–∞–µ–º –Ω—É–º–µ—Ä–∞—Ü–∏—é —Å —É—á–µ—Ç–æ–º offset
            const result = articles.map((article: ArticlePreview, index: number) => {
                const date = article.publishedAt.toLocaleDateString('ru-RU', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                })
                const tags = article.tags.join(', ')
                
                return `${startIndex + index}. **${article.title}**
   üìÖ ${date} | ‚úçÔ∏è ${article.author || '–ê–Ω–æ–Ω–∏–º'}
   üè∑Ô∏è ${tags}
   üìù ${article.summary || '–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç'}
   üîó ${article.url}`
            }).join('\n\n')

            const pageInfo = offset && offset > 0 
                ? ` (—Å—Ç—Ä–∞–Ω–∏—Ü–∞ ${Math.floor(offset / (limit || 5)) + 1}, —Å—Ç–∞—Ç—å–∏ ${offset + 1}-${offset + articles.length})`
                : ''

            return `üìö –ù–∞–π–¥–µ–Ω–æ —Å—Ç–∞—Ç–µ–π: ${articles.length}${pageInfo}\n\n${result}`

        } catch (error) {
            logger.error({ err: error }, '–û—à–∏–±–∫–∞ –≤ newPostsTool')
            return `‚ùå –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å —Å—Ç–∞—Ç—å–∏: ${error instanceof Error ? error.message : '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–∞—è –æ—à–∏–±–∫–∞'}`
        }
    },
    {
        name: 'new_posts',
        description: `–ü–æ–ª—É—á–∞–µ—Ç —Å–ø–∏—Å–æ–∫ —Å–≤–µ–∂–∏—Ö —Å—Ç–∞—Ç–µ–π –∏–∑ RSS-–ª–µ–Ω—Ç—ã —É–∫–∞–∑–∞–Ω–Ω–æ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞ —Å –ø–æ–¥–¥–µ—Ä–∂–∫–æ–π –ø–∞–≥–∏–Ω–∞—Ü–∏–∏.

–ò—Å–ø–æ–ª—å–∑—É–π —ç—Ç–æ—Ç –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∫–æ–≥–¥–∞ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Ö–æ—á–µ—Ç:
- –£–∑–Ω–∞—Ç—å –æ –Ω–æ–≤—ã—Ö —Å—Ç–∞—Ç—å—è—Ö –Ω–∞ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω–Ω—É—é —Ç–µ–º—É
- –£–≤–∏–¥–µ—Ç—å –ø–æ—Å–ª–µ–¥–Ω–∏–µ –ø—É–±–ª–∏–∫–∞—Ü–∏–∏ –∏–∑ –•–∞–±—Ä–∞ –∏–ª–∏ vc.ru
- –ù–∞–π—Ç–∏ —Å—Ç–∞—Ç—å–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–º —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º –∏–ª–∏ —Ç–µ–º–∞–º
- –ó–∞–≥—Ä—É–∑–∏—Ç—å –ï–©–ï —Å—Ç–∞—Ç—å–∏ (–∏—Å–ø–æ–ª—å–∑—É–π offset –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏)

–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
- source: –∏—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç–µ–π (habr, vcru). habr - –•–∞–±—Ä, vcru - vc.ru
- query: –ø–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å/—Ç–µ–º–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: frontend, nodejs, react). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏
- limit: –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)
- offset: —Å–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏ (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 0). –ò—Å–ø–æ–ª—å–∑—É–π –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏ —Å–ª–µ–¥—É—é—â–∏—Ö —Å—Ç–∞—Ç–µ–π
- sinceHours: –ø–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤ (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–í–ê–ñ–ù–û –ø—Ä–æ offset (–ø–∞–≥–∏–Ω–∞—Ü–∏—é):
- –ü–µ—Ä–≤—ã–π –∑–∞–ø—Ä–æ—Å: offset=0 –∏–ª–∏ –Ω–µ —É–∫–∞–∑—ã–≤–∞–π (–ø–æ–∫–∞–∑ –ø–µ—Ä–≤—ã—Ö —Å—Ç–∞—Ç–µ–π)
- –ï—Å–ª–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –ø—Ä–æ—Å–∏—Ç "–µ—â—ë", "–∑–∞–≥—Ä—É–∑–∏ –µ—â—ë", "–ø–æ–∫–∞–∂–∏ –±–æ–ª—å—à–µ", "—Å–ª–µ–¥—É—é—â–∏–µ —Å—Ç–∞—Ç—å–∏":
  * offset = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö —Å—Ç–∞—Ç–µ–π
  * –ù–∞–ø—Ä–∏–º–µ—Ä: –ø–æ–∫–∞–∑–∞–ª 5 —Å—Ç–∞—Ç–µ–π ‚Üí offset=5, –ø–æ–∫–∞–∑–∞–ª –µ—â—ë 5 ‚Üí offset=10, –∏ —Ç.–¥.
- –î–ª—è –∏—Å—Ç–æ—á–Ω–∏–∫–∞ vcru offset –ù–ï —Ä–∞–±–æ—Ç–∞–µ—Ç (API –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ), –∏—Å–ø–æ–ª—å–∑—É–π —Ç–æ–ª—å–∫–æ —É–≤–µ–ª–∏—á–µ–Ω–∏–µ limit
- –°–æ—Ö—Ä–∞–Ω—è–π —Ç–µ –∂–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã (source, query) –ø—Ä–∏ –ø–∞–≥–∏–Ω–∞—Ü–∏–∏

–ü—Ä–∏–º–µ—Ä—ã:
1. "–ü–æ–∫–∞–∂–∏ —Å—Ç–∞—Ç—å–∏ –ø–æ React" ‚Üí source=habr, query="React", offset=0
2. "–ó–∞–≥—Ä—É–∑–∏ –µ—â—ë" ‚Üí source=habr, query="React", offset=5 (–µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞–ª–∏ 5 —Å—Ç–∞—Ç–µ–π)
3. "–ü–æ–∫–∞–∂–∏ —Å–ª–µ–¥—É—é—â–∏–µ" ‚Üí source=habr, query="React", offset=10 (–µ—Å–ª–∏ –ø–æ–∫–∞–∑–∞–ª–∏ 10 —Å—Ç–∞—Ç–µ–π)

–í–æ–∑–≤—Ä–∞—â–∞–µ—Ç: —Å–ø–∏—Å–æ–∫ —Å—Ç–∞—Ç–µ–π —Å –∑–∞–≥–æ–ª–æ–≤–∫–æ–º, –∞–≤—Ç–æ—Ä–æ–º, –¥–∞—Ç–æ–π, —Ç–µ–≥–∞–º–∏, –∫—Ä–∞—Ç–∫–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ–º –∏ —Å—Å—ã–ª–∫–æ–π.`,
        schema: z.object({
            source: z.enum(['habr', 'vcru']).describe('–ò—Å—Ç–æ—á–Ω–∏–∫ —Å—Ç–∞—Ç–µ–π: habr (–•–∞–±—Ä), vcru (vc.ru)'),
            query: z.string().optional().describe('–ü–æ–∏—Å–∫–æ–≤—ã–π –∑–∞–ø—Ä–æ—Å/—Ç–µ–º–∞ (frontend, backend, nodejs, react –∏ —Ç.–¥.). –ï—Å–ª–∏ –Ω–µ —É–∫–∞–∑–∞–Ω - –≤–æ–∑–≤—Ä–∞—â–∞—é—Ç—Å—è –ø–æ–ø—É–ª—è—Ä–Ω—ã–µ —Å—Ç–∞—Ç—å–∏'),
            limit: z.number().optional().describe('–ú–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —Å—Ç–∞—Ç–µ–π (–ø–æ —É–º–æ–ª—á–∞–Ω–∏—é 5)'),
            offset: z.number().optional().describe('–°–º–µ—â–µ–Ω–∏–µ –¥–ª—è –ø–∞–≥–∏–Ω–∞—Ü–∏–∏. 0 = –ø–µ—Ä–≤–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞, 5 = –≤—Ç–æ—Ä–∞—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ (–µ—Å–ª–∏ limit=5), 10 = —Ç—Ä–µ—Ç—å—è —Å—Ç—Ä–∞–Ω–∏—Ü–∞ –∏ —Ç.–¥. –î–ª—è "–µ—â—ë —Å—Ç–∞—Ç–µ–π" –∏—Å–ø–æ–ª—å–∑—É–π offset = –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —É–∂–µ –ø–æ–∫–∞–∑–∞–Ω–Ω—ã—Ö'),
            sinceHours: z.number().optional().describe('–ü–æ–∫–∞–∑–∞—Ç—å —Å—Ç–∞—Ç—å–∏ –∑–∞ –ø–æ—Å–ª–µ–¥–Ω–∏–µ N —á–∞—Å–æ–≤'),
        }),
    }
)

