---

description: Двухэтапная обработка пользовательских сообщений
globs:
  - src/bot/handlers/**
  - src/bot/services/**
alwaysApply: false
---
- Любой новый handler текстовых сообщений (`messageHandler`-подобный) сначала прогоняет текст через валидатор (validatorAgent/validationService), и только потом — через AI или бизнес-логику.
- Валидация должна возвращать структурированный результат (`isValid`, `reason`, `categories`), а не полагаться на парсинг “сырых” текстовых ответов модели.
- При `isValid === false` handler обязан остановить дальнейшую обработку и ответить пользователю понятным сообщением о недопустимой лексике/контенте.
- Валидация — это отдельный слой (validationService + validatorAgent); не дублируйте проверки в каждом handler’е руками.
- Ошибки валидации логируйте, но по умолчанию используйте fail-safe подход (если валидатор упал — не ломайте весь диалог).
